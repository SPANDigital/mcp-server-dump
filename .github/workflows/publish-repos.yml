name: Publish Linux Repositories

on:
  release:
    types: [published]
  workflow_dispatch:

# Prevent concurrent repository updates
concurrency:
  group: linux-repos-update
  cancel-in-progress: false

permissions:
  contents: write
  pages: write
  id-token: write

env:
  REPO_OWNER_LOWER: spandigital  # GitHub Pages URLs are lowercase

jobs:
  publish-repos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup linux-repos branch
        timeout-minutes: 10
        run: |
          set -euo pipefail
          # Check if linux-repos branch exists
          echo "Checking for existing linux-repos branch..."
          if git ls-remote --heads origin linux-repos | grep -q linux-repos; then
            echo "linux-repos branch exists, checking out and updating"

            # Attempt to checkout with retry logic
            for attempt in 1 2 3; do
              if git checkout linux-repos; then
                echo "Successfully checked out linux-repos branch (attempt $attempt)"
                break
              else
                echo "Failed to checkout linux-repos branch (attempt $attempt/3)"
                if [ $attempt -eq 3 ]; then
                  echo "Error: Failed to checkout linux-repos branch after 3 attempts"
                  exit 1
                fi
                sleep 5
              fi
            done

            # Pull latest changes with conflict resolution
            echo "Updating local branch with latest changes..."
            if git pull origin linux-repos; then
              echo "Successfully pulled latest changes"
            else
              echo "Warning: Failed to pull latest changes"
              echo "Checking for conflicts or local modifications..."
              git status --porcelain

              # Try to recover by resetting to remote
              echo "Attempting to reset to match remote branch..."
              if git reset --hard origin/linux-repos; then
                echo "Successfully reset to remote branch state"
              else
                echo "Warning: Could not reset to remote. Continuing with current state."
                echo "This may result in conflicts during publishing."
              fi
            fi

            echo "Branch update completed"
          else
            echo "linux-repos branch does not exist, creating it"

            # Create a backup of current branch info
            CURRENT_BRANCH=$(git branch --show-current)
            echo "Current branch: $CURRENT_BRANCH"

            git checkout -b linux-repos

            # Clear the branch content for repository files only
            # Use git clean for safer cleanup
            git clean -fdx

            # Create initial commit
            git add . 2>/dev/null || true
            git commit -m "Initialize Linux package repository branch" --allow-empty
            git push -u origin linux-repos

            echo "Successfully created and pushed linux-repos branch"
          fi

          # Verify we're on the correct branch
          CURRENT_BRANCH=$(git branch --show-current)
          if [ "$CURRENT_BRANCH" != "linux-repos" ]; then
            echo "Error: Not on linux-repos branch (currently on: $CURRENT_BRANCH)"
            exit 1
          fi

          echo "Branch setup complete - ready to publish packages"

      - name: Download release assets
        timeout-minutes: 15
        uses: dsaltares/fetch-gh-release-asset@aa2ab1243d6e0d5b405b973c89fa4d06a2d0fff7  # v1.1.2
        with:
          version: ${{ github.event.release.tag_name }}
          regex: true
          file: ".*\\.(deb|rpm)$"
          target: "./packages/"

      - name: Verify downloaded packages
        run: |
          set -euo pipefail
          if [ ! -d "./packages" ] || [ -z "$(ls -A ./packages 2>/dev/null)" ]; then
            echo "Error: No packages were downloaded from the release"
            echo "Release: ${{ github.event.release.tag_name }}"
            echo "Expected files: DEB and RPM packages"
            exit 1
          fi
          echo "Downloaded packages:"
          ls -la ./packages/

          # Check package availability and set flags
          DEB_AVAILABLE=false
          RPM_AVAILABLE=false

          if ls ./packages/*.deb >/dev/null 2>&1; then
            DEB_AVAILABLE=true
            echo "✓ DEB packages found: $(ls ./packages/*.deb | wc -l)"
          else
            echo "⚠ Warning: No DEB packages found - APT repository will be skipped"
          fi

          if ls ./packages/*.rpm >/dev/null 2>&1; then
            RPM_AVAILABLE=true
            echo "✓ RPM packages found: $(ls ./packages/*.rpm | wc -l)"
          else
            echo "⚠ Warning: No RPM packages found - YUM repository will be skipped"
          fi

          # Set environment variables for later steps
          echo "DEB_AVAILABLE=$DEB_AVAILABLE" >> $GITHUB_ENV
          echo "RPM_AVAILABLE=$RPM_AVAILABLE" >> $GITHUB_ENV

          # Ensure we have at least some packages
          if [ "$DEB_AVAILABLE" = false ] && [ "$RPM_AVAILABLE" = false ]; then
            echo "❌ Error: No Linux packages found in release"
            echo "Expected: .deb and/or .rpm files"
            exit 1
          fi

      - name: Setup GPG
        run: |
          set -euo pipefail
          # Check if GPG secrets are available
          if [ -z "${{ secrets.GPG_PRIVATE_KEY }}" ]; then
            echo "GPG_PRIVATE_KEY not configured - packages will be unsigned"
            echo "GPG_AVAILABLE=false" >> $GITHUB_ENV
          elif [ -z "${{ secrets.GPG_PUBLIC_KEY }}" ]; then
            echo "GPG_PUBLIC_KEY not configured - packages will be unsigned"
            echo "GPG_AVAILABLE=false" >> $GITHUB_ENV
          else
            echo "Setting up GPG keys for package signing..."
            if echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import --quiet; then
              echo "${{ secrets.GPG_PUBLIC_KEY }}" > public.key
              echo "GPG_AVAILABLE=true" >> $GITHUB_ENV
              echo "GPG keys imported successfully"
            else
              echo "Error: Failed to import GPG private key"
              echo "GPG_AVAILABLE=false" >> $GITHUB_ENV
            fi
          fi

      - name: Create APT repository
        if: env.DEB_AVAILABLE == 'true'
        timeout-minutes: 20
        run: |
          set -euo pipefail
          # Install required tools
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils

          # Create APT directory structure
          mkdir -p apt/pool/main/m/mcp-server-dump
          mkdir -p apt/dists/stable/main/binary-amd64
          mkdir -p apt/dists/stable/main/binary-arm64

          # Copy DEB packages
          cp packages/*.deb apt/pool/main/m/mcp-server-dump/

          # Generate architecture-specific Packages files
          cd apt

          # Process amd64 packages
          if ls ../packages/*_amd64.deb >/dev/null 2>&1; then
            echo "Processing amd64 packages..."
            dpkg-scanpackages --arch amd64 pool/ > dists/stable/main/binary-amd64/Packages
            gzip -k dists/stable/main/binary-amd64/Packages
          else
            echo "No amd64 packages found - creating empty Packages file"
            touch dists/stable/main/binary-amd64/Packages
            gzip -c dists/stable/main/binary-amd64/Packages > dists/stable/main/binary-amd64/Packages.gz
          fi

          # Process arm64 packages
          if ls ../packages/*_arm64.deb >/dev/null 2>&1; then
            echo "Processing arm64 packages..."
            dpkg-scanpackages --arch arm64 pool/ > dists/stable/main/binary-arm64/Packages
            gzip -k dists/stable/main/binary-arm64/Packages
          else
            echo "No arm64 packages found - creating empty Packages file"
            touch dists/stable/main/binary-arm64/Packages
            gzip -c dists/stable/main/binary-arm64/Packages > dists/stable/main/binary-arm64/Packages.gz
          fi

          # Create Contents file
          echo "Generating Contents files..."
          apt-ftparchive contents pool/ > dists/stable/Contents-amd64 || echo "Warning: Contents-amd64 generation failed"
          apt-ftparchive contents pool/ > dists/stable/Contents-arm64 || echo "Warning: Contents-arm64 generation failed"
          gzip -k dists/stable/Contents-amd64
          gzip -k dists/stable/Contents-arm64

          # Generate Release file with proper architecture support
          echo "Generating Release file..."
          cat > dists/stable/Release << EOF
Origin: SPAN Digital
Label: MCP Server Dump
Suite: stable
Codename: stable
Version: 1.0
Architectures: amd64 arm64
Components: main
Description: MCP Server Dump Linux Package Repository
EOF

          apt-ftparchive release dists/stable >> dists/stable/Release

          # Sign Release file (if GPG key is available)
          if [ "$GPG_AVAILABLE" = "true" ]; then
            echo "Signing Release file with GPG..."
            gpg --armor --detach-sign --yes -o dists/stable/Release.gpg dists/stable/Release || {
              echo "Warning: Failed to create detached signature"
            }
            gpg --armor --clearsign --yes -o dists/stable/InRelease dists/stable/Release || {
              echo "Warning: Failed to create clear-signed Release file"
            }
            echo "GPG signing completed"
          else
            echo "GPG not available - APT repository will be unsigned"
          fi

          cd ..

      - name: Create YUM repository
        if: env.RPM_AVAILABLE == 'true'
        timeout-minutes: 20
        run: |
          set -euo pipefail
          # Install required tools
          echo "Installing createrepo-c..."
          sudo apt-get update && sudo apt-get install -y createrepo-c

          # Create YUM directory structure
          mkdir -p yum/x86_64
          mkdir -p yum/aarch64

          # Copy RPM packages with enhanced architecture detection
          echo "Copying RPM packages with architecture detection..."
          x86_64_found=false
          aarch64_found=false
          i386_found=false
          armv7_found=false

          # Create additional architecture directories
          mkdir -p yum/i386 yum/armv7hl

          # Detect and copy x86_64/amd64 packages
          for pattern in "*x86_64.rpm" "*amd64.rpm"; do
            if ls packages/$pattern >/dev/null 2>&1; then
              cp packages/$pattern yum/x86_64/
              x86_64_found=true
              echo "Copied x86_64 packages: $(ls packages/$pattern | wc -l)"
            fi
          done

          # Detect and copy aarch64/arm64 packages
          for pattern in "*aarch64.rpm" "*arm64.rpm"; do
            if ls packages/$pattern >/dev/null 2>&1; then
              cp packages/$pattern yum/aarch64/
              aarch64_found=true
              echo "Copied aarch64 packages: $(ls packages/$pattern | wc -l)"
            fi
          done

          # Detect and copy i386/i686 packages
          for pattern in "*i386.rpm" "*i686.rpm"; do
            if ls packages/$pattern >/dev/null 2>&1; then
              cp packages/$pattern yum/i386/
              i386_found=true
              echo "Copied i386 packages: $(ls packages/$pattern | wc -l)"
            fi
          done

          # Detect and copy armv7 packages
          for pattern in "*armv7*.rpm" "*armhf.rpm"; do
            if ls packages/$pattern >/dev/null 2>&1; then
              cp packages/$pattern yum/armv7hl/
              armv7_found=true
              echo "Copied armv7 packages: $(ls packages/$pattern | wc -l)"
            fi
          done

          # Log architecture summary
          total_archs=0
          if [ "$x86_64_found" = true ]; then ((total_archs++)); fi
          if [ "$aarch64_found" = true ]; then ((total_archs++)); fi
          if [ "$i386_found" = true ]; then ((total_archs++)); fi
          if [ "$armv7_found" = true ]; then ((total_archs++)); fi

          echo "Architecture detection complete: found packages for $total_archs architecture(s)"

          if [ $total_archs -eq 0 ]; then
            echo "Warning: No RPM packages found for any supported architecture"
            echo "Supported patterns: x86_64, amd64, aarch64, arm64, i386, i686, armv7, armhf"
          fi

          # Generate repository metadata for all architectures
          echo "Generating YUM repository metadata..."
          for arch_dir in yum/*/; do
            if [ -d "$arch_dir" ] && [ "$(find "$arch_dir" -name "*.rpm" | wc -l)" -gt 0 ]; then
              arch_name=$(basename "$arch_dir")
              echo "Creating repository metadata for $arch_name..."
              createrepo_c "$arch_dir"
            else
              arch_name=$(basename "$arch_dir")
              echo "Skipping empty architecture directory: $arch_name"
            fi
          done

          # Sign repository metadata (if GPG key is available)
          if [ "$GPG_AVAILABLE" = "true" ]; then
            echo "Signing YUM repository metadata with GPG..."
            for arch_dir in yum/*/; do
              arch_name=$(basename "$arch_dir")
              repomd_file="$arch_dir/repodata/repomd.xml"
              if [ -f "$repomd_file" ]; then
                echo "Signing $arch_name repository metadata..."
                gpg --armor --detach-sign --yes "$repomd_file" || {
                  echo "Warning: Failed to sign $arch_name repository metadata"
                }
              fi
            done
            echo "YUM repository signing completed"
          else
            echo "GPG not available - YUM repositories will be unsigned"
          fi

      - name: Create repository documentation
        run: |
          set -euo pipefail
          # Generate dynamic documentation based on available packages
          APT_SECTION=""
          YUM_SECTION=""

          if [ "$DEB_AVAILABLE" = "true" ]; then
            APT_SECTION='
              <h2>APT Repository (Debian/Ubuntu)</h2>
              <h3>Quick Install</h3>
              <pre>
# Add the repository
echo "deb [trusted=yes] https://${{ env.REPO_OWNER_LOWER }}.github.io/mcp-server-dump/apt stable main" | sudo tee /etc/apt/sources.list.d/mcp-server-dump.list

# Update and install
sudo apt update
sudo apt install mcp-server-dump
              </pre>

              <h3>With GPG verification (if available)</h3>
              <pre>
# Import GPG key
curl -fsSL https://${{ env.REPO_OWNER_LOWER }}.github.io/mcp-server-dump/public.key | sudo gpg --dearmor -o /usr/share/keyrings/mcp-server-dump.gpg

# Add the repository
echo "deb [signed-by=/usr/share/keyrings/mcp-server-dump.gpg] https://${{ env.REPO_OWNER_LOWER }}.github.io/mcp-server-dump/apt stable main" | sudo tee /etc/apt/sources.list.d/mcp-server-dump.list

# Update and install
sudo apt update
sudo apt install mcp-server-dump
              </pre>'
          fi

          if [ "$RPM_AVAILABLE" = "true" ]; then
            YUM_SECTION='
              <h2>YUM Repository (RHEL/Fedora/CentOS)</h2>
              <h3>Quick Install</h3>
              <pre>
# Add the repository
sudo tee /etc/yum.repos.d/mcp-server-dump.repo << '\''REPO'\''
[mcp-server-dump]
name=MCP Server Dump
baseurl=https://${{ env.REPO_OWNER_LOWER }}.github.io/mcp-server-dump/yum/\$basearch
enabled=1
gpgcheck=0
REPO

# Install
sudo dnf install mcp-server-dump
              </pre>

              <h3>With GPG verification (if available)</h3>
              <pre>
# Import GPG key
sudo rpm --import https://${{ env.REPO_OWNER_LOWER }}.github.io/mcp-server-dump/public.key

# Add the repository
sudo tee /etc/yum.repos.d/mcp-server-dump.repo << '\''REPO'\''
[mcp-server-dump]
name=MCP Server Dump
baseurl=https://${{ env.REPO_OWNER_LOWER }}.github.io/mcp-server-dump/yum/\$basearch
enabled=1
gpgcheck=1
gpgkey=https://${{ env.REPO_OWNER_LOWER }}.github.io/mcp-server-dump/public.key
REPO

# Install
sudo dnf install mcp-server-dump
              </pre>'
          fi

          cat > index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>MCP Server Dump - Linux Package Repository</title>
              <style>
                  body { font-family: system-ui, -apple-system, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                  pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
                  h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
                  .note { background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; }
                  .warning { background: #f8d7da; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #dc3545; }
              </style>
          </head>
          <body>
              <h1>MCP Server Dump - Linux Package Repository</h1>

              <p>Official Linux package repository for <a href="https://github.com/${{ github.repository }}">mcp-server-dump</a></p>

          \$APT_SECTION

          \$YUM_SECTION

              <div class="note">
                  <strong>Note:</strong> Replace <code>dnf</code> with <code>yum</code> on older RHEL/CentOS systems.
              </div>

              <h2>Direct Package Downloads</h2>
              <ul>
                  <li><a href="https://github.com/${{ github.repository }}/releases/latest">Latest Release on GitHub</a></li>
              </ul>
          </body>
          </html>
          EOF

      - name: Commit and push changes
        timeout-minutes: 10
        run: |
          set -euo pipefail
          git config --local user.email "bot@goreleaser.com"
          git config --local user.name "GoReleaser Bot"

          # Check if there are any changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git add .
          git commit -m "Update Linux repositories for ${{ github.event.release.tag_name }}"
          git push

          echo "Successfully updated Linux repositories"

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4