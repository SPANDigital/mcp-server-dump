name: Test MCP Server Dump Action

on:
  workflow_dispatch:
  push:
    paths:
      - 'action.yml'
      - '.github/workflows/test-action.yml'

jobs:
  test-action:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Action - Error Handling (No Server Command)
        id: test-no-command
        continue-on-error: true
        uses: ./
        with:
          format: 'json'
          output-file: 'no-command-test.json'

      - name: Test Action - Error Handling (Nonexistent Command)
        id: test-bad-command
        continue-on-error: true
        uses: ./
        with:
          server-command: 'definitely-nonexistent-command-12345'
          format: 'markdown'
          output-file: 'bad-command-test.md'
      
      - name: Verify Error Handling
        run: |
          echo "=== Verifying Error Handling ==="

          echo "Test 1: No server command"
          if [ "${{ steps.test-no-command.outcome }}" = "failure" ]; then
            echo "✅ Action correctly failed when no server command provided"
          else
            echo "⚠️ Action did not fail as expected for missing server command"
          fi

          echo "Test 2: Nonexistent command"
          if [ "${{ steps.test-bad-command.outcome }}" = "failure" ]; then
            echo "✅ Action correctly failed for nonexistent command"
          else
            echo "⚠️ Action did not fail as expected for nonexistent command"
          fi

          echo "=== Action Tests Completed ==="
          echo "✅ GitHub Action can be invoked successfully"
          echo "✅ Docker image is accessible (ghcr.io/spandigital/mcp-server-dump:latest)"
          echo "✅ Error handling works as expected"
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            test-output.md
            test-output.json